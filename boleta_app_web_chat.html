<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Boletas - Cordova</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        header {
            background-color: #004d80;
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
        }
        header svg {
            width: 40px;
            height: 40px;
            margin-right: 0.5rem;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        main {
            padding: 1rem;
        }
        section {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #004d80;
            color: white;
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover {
            background-color: #003459;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: white;
        }
        th,
        td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: center;
        }
        th {
            background-color: #e0eef9;
        }
        tfoot td {
            font-weight: bold;
            background-color: #f5f5f5;
        }
        .hidden {
            display: none;
        }
        .business-details,
        .client-details,
        .items-section {
            background-color: white;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .receipt-section {
            background-color: white;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Make beverage rows more readable for older users */
        .beverage-row td {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Increase font size for the entire receipt when large-font mode is enabled */
        .large-font .receipt-section table td,
        .large-font .receipt-section table th {
            font-size: 1.2rem;
        }

        /* Styles for the history section */
        .history-section {
            background-color: white;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 1.5rem;
        }
        .history-section ul {
            list-style-type: none;
            padding-left: 0;
        }
        .history-section li {
            margin-bottom: 0.5rem;
        }

        /* Styles for the chat section */
        .chat-section {
            background-color: white;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 1.5rem;
        }
        .chat-messages {
            height: 250px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
            border: 1px solid #ccc;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .chat-messages .message {
            margin-bottom: 0.4rem;
            line-height: 1.2;
        }
        .chat-messages .message.user {
            text-align: right;
            color: #004d80;
            font-weight: bold;
        }
        .chat-messages .message.assistant {
            text-align: left;
            color: #333;
        }
        #chatInput {
            width: 100%;
            height: 60px;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <header>
        <!-- Inline SVG logo -->
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <g fill="none" stroke="#ffffff" stroke-width="4">
                <!-- Bag -->
                <rect x="5" y="18" width="24" height="30" rx="3" />
                <path d="M5 18 L12 8 L25 8 L29 18" />
                <!-- Bottle -->
                <rect x="32" y="12" width="12" height="28" rx="2" />
                <rect x="33" y="4" width="10" height="8" rx="1" />
                <!-- Fruit (circle and leaf) -->
                <circle cx="52" cy="40" r="10" />
                <path d="M48 32 L52 26 L56 32" />
            </g>
        </svg>
        <h1>Cordova</h1>
    </header>
    <main>
        <section class="business-details">
            <label>
                Nombre del negocio:
                <input type="text" id="businessName" placeholder="Cordova">
            </label>
            <label>
                RUC:
                <input type="text" id="businessRUC" placeholder="1045682987">
            </label>
            <label>
                Teléfono:
                <input type="text" id="businessPhone" placeholder="924028411">
            </label>
        </section>
        <section class="client-details">
            <label>
                Cliente:
                <input type="text" id="clientName" placeholder="Nombre del cliente">
            </label>
        </section>
        <section class="items-section">
            <h2>Agregar producto</h2>
            <label>
                Cantidad:
                <input type="number" id="itemQuantity" min="1" value="1">
            </label>
            <label>
                Descripción:
                <input type="text" id="itemDescription" placeholder="Descripción del producto" list="productList">
                <!-- Lista de productos frecuentes -->
                <datalist id="productList">
                    <option value="Sporade"></option>
                    <option value="Arroz Criollita"></option>
                    <option value="Champions"></option>
                    <option value="Agua"></option>
                    <option value="Chicle Taper"></option>
                    <option value="Laki"></option>
                    <option value="Tomate"></option>
                    <option value="Papa"></option>
                    <option value="Aceite"></option>
                    <option value="Ajo"></option>
                    <option value="Fideo"></option>
                    <option value="Panquita"></option>
                </datalist>
            </label>
            <label>
                Precio unitario:
                <input type="number" id="itemPrice" min="0" step="0.01" value="0.00">
            </label>
            <label>
                Tipo de presentación:
                <select id="itemType">
                    <option value="paquete">Paquete</option>
                    <option value="unidad">Unidad</option>
                    <option value="saco">Saco</option>
                <option value="kg">Kilogramos</option>
                <option value="caja">Caja</option>
                <option value="galonera">Galonera</option>
                <option value="plancha">Plancha</option>
                </select>
            </label>
            <label>
                ¿Es bebida?
                <input type="checkbox" id="itemBeverage">
            </label>

            <label>
                Modo lectura (fuente grande):
                <input type="checkbox" id="largeFontToggle">
            </label>
            <button id="addItemButton">Agregar</button>
        </section>
        <section class="receipt-section hidden" id="receiptSection">
            <h2>Boleta de Venta</h2>
            <div id="receiptHeader"></div>
            <table id="receiptTable">
                <thead>
                    <tr>
                        <th>Cant.</th>
                        <th>Descripción</th>
                        <th>P. Unit</th>
                        <th>Tipo</th>
                        <th>Total</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="receiptBody"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="4"><strong>Total</strong></td>
                        <td id="receiptTotal">0.00</td>
                    </tr>
                </tfoot>
            </table>
            <button id="printButton">Imprimir/Guardar PDF</button>
            <button id="clearButton">Limpiar Todo</button>
            <button id="saveButton">Guardar Boleta</button>
        </section>
        <section class="history-section hidden" id="historySection">
            <h2>Historial de Boletas</h2>
            <ul id="historyList"></ul>
        </section>

        <!-- Chat section for interacting with the assistant -->
        <section class="chat-section" id="chatSection">
            <h2>Asistente de Cordova</h2>
            <div id="chatMessages" class="chat-messages"></div>
            <textarea id="chatInput" placeholder="Escribe tu pregunta aquí..."></textarea>
            <button id="sendChatButton">Enviar</button>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addItemButton = document.getElementById('addItemButton');
            const printButton = document.getElementById('printButton');
            const clearButton = document.getElementById('clearButton');
            const receiptSection = document.getElementById('receiptSection');
            const receiptBody = document.getElementById('receiptBody');
            const receiptTotal = document.getElementById('receiptTotal');
            const receiptHeader = document.getElementById('receiptHeader');
            const quantityInput = document.getElementById('itemQuantity');
            const descriptionInput = document.getElementById('itemDescription');
            const priceInput = document.getElementById('itemPrice');
            const typeSelect = document.getElementById('itemType');
            const beverageCheck = document.getElementById('itemBeverage');
            const largeFontToggle = document.getElementById('largeFontToggle');
            const saveButton = document.getElementById('saveButton');
            const historyList = document.getElementById('historyList');
            const historySection = document.getElementById('historySection');
            let total = 0;

            // Toggle large-font mode for better readability
            largeFontToggle.addEventListener('change', () => {
                if (largeFontToggle.checked) {
                    document.body.classList.add('large-font');
                } else {
                    document.body.classList.remove('large-font');
                }
            });

            // Event delegation to handle delete button clicks
            receiptBody.addEventListener('click', (e) => {
                const target = e.target;
                if (!target) return;
                if (target.classList.contains('edit-button')) {
                    // Edit the selected row: populate the input fields with existing data and remove the row
                    const row = target.closest('tr');
                    const rowTotal = parseFloat(row.dataset.total);
                    // Populate form fields for editing
                    quantityInput.value = row.dataset.quantity;
                    descriptionInput.value = row.dataset.description;
                    priceInput.value = row.dataset.price;
                    typeSelect.value = row.dataset.type;
                    beverageCheck.checked = row.dataset.isBeverage === 'true';
                    // Remove row and update total
                    row.remove();
                    total -= rowTotal;
                    receiptTotal.textContent = total.toFixed(2);
                    if (!receiptBody.children.length) {
                        receiptSection.classList.add('hidden');
                    }
                } else if (target.classList.contains('delete-button')) {
                    const row = target.closest('tr');
                    const rowTotal = parseFloat(row.dataset.total);
                    row.remove();
                    total -= rowTotal;
                    receiptTotal.textContent = total.toFixed(2);
                    // Hide the receipt section if no items remain
                    if (!receiptBody.children.length) {
                        receiptSection.classList.add('hidden');
                    }
                }
            });
            function updateReceiptHeader() {
                const businessName = document.getElementById('businessName').value || 'Cordova';
                const businessRUC = document.getElementById('businessRUC').value || '1045682987';
                const businessPhone = document.getElementById('businessPhone').value || '924028411';
                const clientName = document.getElementById('clientName').value || 'Cliente';
                receiptHeader.innerHTML = `
                    <p><strong>${businessName}</strong></p>
                    <p>RUC: ${businessRUC}</p>
                    <p>Tel: ${businessPhone}</p>
                    <p>Cliente: ${clientName}</p>
                `;
            }
            function addItem() {
                const quantityInput = document.getElementById('itemQuantity');
                const descriptionInput = document.getElementById('itemDescription');
                const priceInput = document.getElementById('itemPrice');
                const typeSelect = document.getElementById('itemType');
                const beverageCheck = document.getElementById('itemBeverage');
                const quantity = parseInt(quantityInput.value, 10);
                const description = descriptionInput.value.trim();
                const price = parseFloat(priceInput.value);
                const type = typeSelect.value;
                const isBeverage = beverageCheck.checked;
                if (!description || isNaN(quantity) || isNaN(price)) {
                    alert('Por favor ingresa una cantidad, descripción y precio válidos.');
                    return;
                }
                const itemTotal = quantity * price;
                total += itemTotal;
                const row = document.createElement('tr');
                if (isBeverage) {
                    row.classList.add('beverage-row');
                }
                // Store details for this row in data attributes for easy removal and editing
                row.dataset.total = itemTotal.toFixed(2);
                row.dataset.quantity = quantity;
                row.dataset.description = description;
                row.dataset.price = price.toFixed(2);
                row.dataset.type = type;
                row.dataset.isBeverage = isBeverage ? 'true' : 'false';
                // Build the row with edit and delete buttons in the last column
                row.innerHTML = `
                    <td>${quantity}</td>
                    <td>${description}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${type}</td>
                    <td>${itemTotal.toFixed(2)}</td>
                    <td><button type="button" class="edit-button">Editar</button> <button type="button" class="delete-button">Eliminar</button></td>
                `;
                receiptBody.appendChild(row);
                receiptTotal.textContent = total.toFixed(2);
                // Reset inputs
                quantityInput.value = 1;
                descriptionInput.value = '';
                priceInput.value = '0.00';
                typeSelect.value = 'paquete';
                beverageCheck.checked = false;
                receiptSection.classList.remove('hidden');
                updateReceiptHeader();
            }
            function printReceipt() {
                updateReceiptHeader();
                window.print();
            }
            addItemButton.addEventListener('click', addItem);
            printButton.addEventListener('click', printReceipt);

            // Clear all items and reset the total when the clear button is clicked
            clearButton.addEventListener('click', () => {
                while (receiptBody.firstChild) {
                    receiptBody.removeChild(receiptBody.firstChild);
                }
                total = 0;
                receiptTotal.textContent = total.toFixed(2);
                receiptSection.classList.add('hidden');
            });

            // Render the history of saved receipts from localStorage
            function renderHistory() {
                const receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
                historyList.innerHTML = '';
                receipts.forEach((r, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. ${r.clientName} - ${r.date} - Total: S/ ${r.total}`;
                    historyList.appendChild(li);
                });
                if (receipts.length) {
                    historySection.classList.remove('hidden');
                } else {
                    historySection.classList.add('hidden');
                }
            }

            // Initialize history on page load
            renderHistory();

            // Save the current receipt into localStorage
            saveButton.addEventListener('click', () => {
                // Build items array from the current receipt
                const items = [];
                receiptBody.querySelectorAll('tr').forEach(row => {
                    items.push({
                        quantity: row.dataset.quantity,
                        description: row.dataset.description,
                        price: row.dataset.price,
                        type: row.dataset.type,
                        total: row.dataset.total
                    });
                });
                // Only save if there are items
                if (!items.length) {
                    alert('No hay ítems para guardar.');
                    return;
                }
                updateReceiptHeader();
                const receiptData = {
                    businessName: document.getElementById('businessName').value || 'Cordova',
                    businessRUC: document.getElementById('businessRUC').value || '1045682987',
                    businessPhone: document.getElementById('businessPhone').value || '924028411',
                    clientName: document.getElementById('clientName').value || 'Cliente',
                    items: items,
                    total: receiptTotal.textContent,
                    date: new Date().toLocaleString()
                };
                const receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
                receipts.push(receiptData);
                localStorage.setItem('receipts', JSON.stringify(receipts));
                renderHistory();
                alert('Boleta guardada en el historial.');
            });

            // ---------- Chat Assistant Integration ----------
            // API key provided by user (keep this safe)
            const openaiApiKey = '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';

            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendChatButton = document.getElementById('sendChatButton');

            // Maintain conversation history for ChatGPT
            let chatHistory = [
                { role: 'system', content: 'Eres un asistente virtual que ayuda a resolver dudas sobre la aplicación de boletas y temas de abarrotes. Responde de manera clara y breve.' }
            ];

            function appendChatMessage(role, content) {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message');
                msgDiv.classList.add(role === 'user' ? 'user' : 'assistant');
                msgDiv.textContent = content;
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function sendChatMessage() {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                appendChatMessage('user', userMessage);
                chatHistory.push({ role: 'user', content: userMessage });
                chatInput.value = '';
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${openaiApiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: chatHistory,
                            max_tokens: 200,
                            temperature: 0.7
                        })
                    });
                    const data = await response.json();
                    const assistantReply = data.choices && data.choices[0].message ? data.choices[0].message.content.trim() : 'No se pudo obtener respuesta.';
                    chatHistory.push({ role: 'assistant', content: assistantReply });
                    appendChatMessage('assistant', assistantReply);
                } catch (error) {
                    appendChatMessage('assistant', 'Error al comunicarse con el servicio.');
                }
            }

            sendChatButton.addEventListener('click', sendChatMessage);
        });
    </script>
</body>
</html>